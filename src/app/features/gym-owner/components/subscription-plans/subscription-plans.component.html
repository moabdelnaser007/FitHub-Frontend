<div class="plans-page">

  <!-- Page Header -->
  <div>
    <div>
      <h1>Branch Plans</h1>
      <p>View and manage subscription plans for this branch.</p>
      <br>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading plans...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="loadError && !isLoading" class="error-state">
    <span class="material-icons">error</span>
    <p>{{ loadError }}</p>
    <button class="btn-retry" (click)="goBack()">Back to Branch</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !loadError">

    <!-- Search and Actions -->
    <div class="toolbar">
      <div class="search-container">
        <span class="material-symbols-outlined search-icon">search</span>
        <input
          type="text"
          class="search-input"
          placeholder="Search by name or description..."
          [(ngModel)]="searchQuery"
          (input)="onSearch()"
        />
      </div>

      <button class="btn-add" (click)="addNewPlan()">
        <span class="material-symbols-outlined">add</span>
        <span>Add New Plan</span>
      </button>
    </div>

    <!-- Plans Table -->
    <div class="table-container">
      <table class="plans-table">
        <thead>
          <tr>
            <th>Plan Name</th>
            <th>Description</th>
            <th>Credits</th>
            <th>Visits</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let plan of filteredPlans">
            <td>{{ plan.name }}</td>
            <td>{{ plan.description || 'N/A' }}</td>
            <td>{{ plan.creditsCost }}</td>
            <td>{{ plan.visitsLimit }}</td>
            <td>{{ getDurationText(plan.durationDays) }}</td>

            <td>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  [checked]="plan.status === 'ACTIVE'"
                  (change)="toggleStatus(plan)"
                />
                <span class="toggle-slider"></span>
              </label>

              <span class="status-text" [ngClass]="getStatusClass(plan.status)">
                {{ getStatusText(plan.status) }}
              </span>
            </td>

            <td>
              <button class="action-btn edit-btn" (click)="editPlan(plan)">
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button class="action-btn delete-btn" (click)="deletePlan(plan)">
                <span class="material-symbols-outlined">delete</span>
              </button>
            </td>
          </tr>

          <tr *ngIf="filteredPlans.length === 0">
            <td colspan="7" class="empty-state">
              No plans found
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Back Button -->
    <div class="back-button-container">
      <button class="btn-back" (click)="goBack()">
        <span class="material-symbols-outlined">arrow_back</span>
        Back to Branches list
      </button>
    </div>
  </div>

  <!-- Delete Modal -->
  <div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <h2>Delete Plan</h2>
        <button class="close-btn" (click)="closeDeleteModal()" [disabled]="isDeleting">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body">
        <div class="warning-icon">
          <span class="material-symbols-outlined">warning</span>
        </div>
        <p class="warning-text">
          Are you sure you want to delete <strong>{{ planToDelete?.name }}</strong>?
        </p>
        <p class="warning-subtext">
          This action cannot be undone. All data associated with this plan will be permanently deleted.
        </p>
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button 
          class="btn-cancel-modal" 
          (click)="closeDeleteModal()"
          [disabled]="isDeleting"
        >
          Cancel
        </button>
        <button 
          class="btn-delete-modal" 
          (click)="confirmDelete()"
          [disabled]="isDeleting"
        >
          <span *ngIf="!isDeleting">Delete Plan</span>
          <span *ngIf="isDeleting" class="deleting-state">
            <div class="spinner-small"></div>
            Deleting...
          </span>
        </button>
      </div>
      
    </div>
  </div>

</div>